<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug TAGMe Collaborations</title>
  </head>
  <body>
    <h1>üîç Debug TAGMe Collaborations Issue</h1>
    <button onclick="runDebug()">Run Debug</button>
    <div id="output"></div>

    <script>
      function log(message) {
        const output = document.getElementById('output');
        output.innerHTML += '<p>' + message + '</p>';
        console.log(message);
      }

      function runDebug() {
        log('üîç Debugging TAGMe collaborations issue...');

        // Ê£ÄÊü• localStorage ‰∏≠ÁöÑÂçè‰ΩúÊï∞ÊçÆ
        const stored = localStorage.getItem('mock_collaborations');
        log('üì¶ Raw stored data: ' + (stored ? 'Found' : 'Not found'));

        if (stored) {
          const collaborations = JSON.parse(stored);
          log('üìã Total collaborations in storage: ' + collaborations.length);

          // ÊòæÁ§∫ÊâÄÊúâÂçè‰ΩúÈ°πÁõÆ
          collaborations.forEach((collab, index) => {
            log(
              `${index + 1}. ${collab.title} (by ${
                collab.author?.id || 'unknown'
              })`
            );
          });

          // Ê£ÄÊü•ÊòØÂê¶Êúâ Alex ÁöÑÂçè‰ΩúÈ°πÁõÆ
          const alexCollaborations = collaborations.filter(
            c => c.author && c.author.id === 'alex'
          );
          log('üë§ Alex collaborations: ' + alexCollaborations.length);

          // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÖ∂‰ªñÁî®Êà∑ÁöÑÂçè‰ΩúÈ°πÁõÆ
          const otherCollaborations = collaborations.filter(
            c => c.author && c.author.id !== 'alex'
          );
          log('üë• Other users collaborations: ' + otherCollaborations.length);

          // Ê£ÄÊü•Âçè‰ΩúÈ°πÁõÆÁöÑÁä∂ÊÄÅ
          const activeCollaborations = collaborations.filter(
            c => c.status === 'active'
          );
          log('‚úÖ Active collaborations: ' + activeCollaborations.length);

          // Ê£ÄÊü•Âçè‰ΩúÈ°πÁõÆÁöÑÂàõÂª∫Êó∂Èó¥
          collaborations.forEach(collab => {
            log(`üìÖ ${collab.title}: created at ${collab.createdAt}`);
          });
        } else {
          log('‚ùå No collaborations found in localStorage');
        }

        // Ê®°Êãü TAGMe È°µÈù¢ÁöÑ getCollaborations Ë∞ÉÁî®
        log('üîç Simulating TAGMe getCollaborations call...');

        // Ê®°Êãü getCollaborationsFromStorage ÂáΩÊï∞
        const getCollaborationsFromStorage = () => {
          try {
            const stored = localStorage.getItem('mock_collaborations');
            const parsed = stored ? JSON.parse(stored) : [];
            log(
              'üìä getCollaborationsFromStorage returned: ' +
                parsed.length +
                ' collaborations'
            );
            return parsed;
          } catch (error) {
            log('Error reading collaborations from storage: ' + error);
            return [];
          }
        };

        // Ê®°Êãü getCollaborations ÂáΩÊï∞
        const getCollaborations = async (options = {}) => {
          try {
            const queryOptions = {
              page: 1,
              limit: 12,
              status: 'active',
              authorId: null,
              searchTerm: '',
              sortBy: 'createdAt',
              sortOrder: 'desc',
              ...options,
            };

            let collaborations = getCollaborationsFromStorage();
            log('üìã Initial collaborations count: ' + collaborations.length);

            // Á≠õÈÄâÈÄªËæë
            if (queryOptions.authorId) {
              collaborations = collaborations.filter(
                c => c.author.id === queryOptions.authorId
              );
              log('üîç After authorId filter: ' + collaborations.length);
            }

            if (queryOptions.status) {
              collaborations = collaborations.filter(
                c => c.status === queryOptions.status
              );
              log('üîç After status filter: ' + collaborations.length);
            }

            if (queryOptions.searchTerm) {
              const searchTerm = queryOptions.searchTerm.toLowerCase();
              collaborations = collaborations.filter(
                c =>
                  c.title.toLowerCase().includes(searchTerm) ||
                  c.description.toLowerCase().includes(searchTerm) ||
                  c.projectVision.toLowerCase().includes(searchTerm)
              );
              log('üîç After searchTerm filter: ' + collaborations.length);
            }

            // ÊéíÂ∫èÈÄªËæë
            collaborations.sort((a, b) => {
              const aValue = a[queryOptions.sortBy];
              const bValue = b[queryOptions.sortBy];

              if (queryOptions.sortOrder === 'desc') {
                return new Date(bValue) - new Date(aValue);
              } else {
                return new Date(aValue) - new Date(bValue);
              }
            });

            // ÂàÜÈ°µÈÄªËæë
            const total = collaborations.length;
            const totalPages = Math.ceil(total / queryOptions.limit);
            const startIndex = (queryOptions.page - 1) * queryOptions.limit;
            const endIndex = startIndex + queryOptions.limit;
            const paginatedCollaborations = collaborations.slice(
              startIndex,
              endIndex
            );

            log(
              'üìÑ Final result: ' +
                JSON.stringify(
                  {
                    total,
                    totalPages,
                    startIndex,
                    endIndex,
                    paginatedCount: paginatedCollaborations.length,
                  },
                  null,
                  2
                )
            );

            return {
              success: true,
              data: paginatedCollaborations,
              pagination: {
                page: queryOptions.page,
                limit: queryOptions.limit,
                total,
                totalPages,
                hasNext: queryOptions.page < totalPages,
                hasPrev: queryOptions.page > 1,
              },
            };
          } catch (error) {
            log('Error fetching collaborations: ' + error);
            return {
              success: false,
              error: error.message || 'Failed to fetch collaborations',
            };
          }
        };

        // ÊµãËØï TAGMe È°µÈù¢ÁöÑË∞ÉÁî®
        getCollaborations().then(result => {
          log(
            'üéØ TAGMe getCollaborations result: ' +
              JSON.stringify(result, null, 2)
          );
          if (result.success) {
            log(
              'üìä TAGMe should display: ' +
                result.data.length +
                ' collaborations'
            );
            result.data.forEach((collab, index) => {
              log(`${index + 1}. ${collab.title} (${collab.author?.id})`);
            });
          } else {
            log('‚ùå TAGMe getCollaborations failed: ' + result.error);
          }
        });

        log('‚úÖ Debug completed!');
      }
    </script>
  </body>
</html>

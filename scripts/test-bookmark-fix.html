<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bookmark Fix Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-card {
        border: 1px solid #ccc;
        padding: 20px;
        margin: 10px 0;
        border-radius: 5px;
        position: relative;
      }
      .bookmark-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .bookmark-btn.favorited {
        color: purple;
      }
      .bookmark-btn:not(.favorited) {
        color: gray;
      }
      .log {
        background: #f8f9fa;
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>æ”¶è—åŠŸèƒ½ä¿®å¤æµ‹è¯•</h1>

    <div class="test-card">
      <h3>æµ‹è¯•åä½œ 1</h3>
      <p>ID: collab_test_1</p>
      <button
        class="bookmark-btn"
        onclick="toggleBookmark('collab_test_1')"
        id="btn_collab_test_1"
      >
        â¤
      </button>
    </div>

    <div class="test-card">
      <h3>æµ‹è¯•åä½œ 2</h3>
      <p>ID: collab_test_2</p>
      <button
        class="bookmark-btn"
        onclick="toggleBookmark('collab_test_2')"
        id="btn_collab_test_2"
      >
        â¤
      </button>
    </div>

    <div>
      <button onclick="checkAllStatus()">æ£€æŸ¥æ‰€æœ‰æ”¶è—çŠ¶æ€</button>
      <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
      <button onclick="clearStorage()">æ¸…é™¤å­˜å‚¨</button>
    </div>

    <div class="log" id="log"></div>

    <script>
      // æ¨¡æ‹Ÿæ”¶è—æœåŠ¡
      const favoritesService = {
        async toggleFavorite(itemType, itemId, shouldFavorite) {
          const currentUser = getCurrentUser();
          if (!currentUser?.id) {
            throw new Error('User not authenticated');
          }

          const storage = await this._getStorage();
          const userFavorites = storage[currentUser.id] || [];

          if (shouldFavorite) {
            // æ·»åŠ æ”¶è—
            const existingIndex = userFavorites.findIndex(
              fav => fav.itemType === itemType && fav.itemId === itemId
            );

            if (existingIndex === -1) {
              const newFavorite = {
                id: this._generateId(),
                userId: currentUser.id,
                itemType,
                itemId,
                createdAt: new Date().toISOString(),
              };

              userFavorites.push(newFavorite);
              storage[currentUser.id] = userFavorites;
              await this._setStorage(storage);

              log(`âœ… æ·»åŠ æ”¶è—æˆåŠŸ: ${itemId}`);
              return { success: true, data: newFavorite };
            } else {
              log(`â„¹ï¸ å·²æ”¶è—ï¼Œæ— éœ€é‡å¤æ·»åŠ : ${itemId}`);
              return { success: true, data: userFavorites[existingIndex] };
            }
          } else {
            // ç§»é™¤æ”¶è—
            const existingIndex = userFavorites.findIndex(
              fav => fav.itemType === itemType && fav.itemId === itemId
            );

            if (existingIndex !== -1) {
              const removedFavorite = userFavorites.splice(existingIndex, 1)[0];
              storage[currentUser.id] = userFavorites;
              await this._setStorage(storage);

              log(`âœ… ç§»é™¤æ”¶è—æˆåŠŸ: ${itemId}`);
              return { success: true, data: removedFavorite };
            } else {
              log(`â„¹ï¸ æœªæ”¶è—ï¼Œæ— éœ€ç§»é™¤: ${itemId}`);
              return { success: true, data: null };
            }
          }
        },

        async checkFavoriteStatus(itemType, itemId) {
          const currentUser = getCurrentUser();
          if (!currentUser?.id) {
            return {
              success: true,
              data: { isFavorited: false, favoriteId: null },
            };
          }

          const storage = await this._getStorage();
          const userFavorites = storage[currentUser.id] || [];

          const favorite = userFavorites.find(
            fav => fav.itemType === itemType && fav.itemId === itemId
          );

          return {
            success: true,
            data: {
              isFavorited: !!favorite,
              favoriteId: favorite?.id || null,
            },
          };
        },

        async _getStorage() {
          try {
            const data = localStorage.getItem('tag_favorites');
            return data ? JSON.parse(data) : {};
          } catch (error) {
            console.error('Failed to get favorites from storage:', error);
            return {};
          }
        },

        async _setStorage(data) {
          try {
            localStorage.setItem('tag_favorites', JSON.stringify(data));
          } catch (error) {
            console.error('Failed to save favorites to storage:', error);
          }
        },

        _generateId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
        },
      };

      function getCurrentUser() {
        const userId = localStorage.getItem('tag.currentUserId');
        return userId ? { id: userId } : null;
      }

      function log(message) {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.textContent += `[${timestamp}] ${message}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateButtonState(itemId, isFavorited) {
        const btn = document.getElementById(`btn_${itemId}`);
        if (isFavorited) {
          btn.classList.add('favorited');
          btn.textContent = 'â¤';
        } else {
          btn.classList.remove('favorited');
          btn.textContent = 'ğŸ¤';
        }
      }

      async function toggleBookmark(itemId) {
        try {
          log(`ğŸ”„ å¼€å§‹åˆ‡æ¢æ”¶è—: ${itemId}`);

          // å…ˆæ£€æŸ¥å½“å‰çŠ¶æ€
          const statusResult = await favoritesService.checkFavoriteStatus(
            'collaboration',
            itemId
          );
          const currentState = statusResult.data.isFavorited;

          log(`ğŸ“Š å½“å‰æ”¶è—çŠ¶æ€: ${currentState ? 'å·²æ”¶è—' : 'æœªæ”¶è—'}`);

          // åˆ‡æ¢çŠ¶æ€
          const result = await favoritesService.toggleFavorite(
            'collaboration',
            itemId,
            !currentState
          );

          if (result.success) {
            // éªŒè¯æ–°çŠ¶æ€
            const verifyResult = await favoritesService.checkFavoriteStatus(
              'collaboration',
              itemId
            );
            const newState = verifyResult.data.isFavorited;

            log(`âœ… åˆ‡æ¢å®Œæˆï¼ŒéªŒè¯çŠ¶æ€: ${newState ? 'å·²æ”¶è—' : 'æœªæ”¶è—'}`);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonState(itemId, newState);

            // æ£€æŸ¥çŠ¶æ€æ˜¯å¦ä¸€è‡´
            if (newState === !currentState) {
              log(`ğŸ‰ çŠ¶æ€éªŒè¯æˆåŠŸï¼`);
            } else {
              log(`âŒ çŠ¶æ€éªŒè¯å¤±è´¥ï¼æœŸæœ›: ${!currentState}, å®é™…: ${newState}`);
            }
          } else {
            log(`âŒ åˆ‡æ¢å¤±è´¥: ${result.error}`);
          }
        } catch (error) {
          log(`âŒ æ“ä½œå‡ºé”™: ${error.message}`);
        }
      }

      async function checkAllStatus() {
        log('ğŸ” æ£€æŸ¥æ‰€æœ‰æ”¶è—çŠ¶æ€...');

        const items = ['collab_test_1', 'collab_test_2'];

        for (const itemId of items) {
          try {
            const result = await favoritesService.checkFavoriteStatus(
              'collaboration',
              itemId
            );
            const isFavorited = result.data.isFavorited;

            log(`ğŸ“Š ${itemId}: ${isFavorited ? 'å·²æ”¶è—' : 'æœªæ”¶è—'}`);
            updateButtonState(itemId, isFavorited);
          } catch (error) {
            log(`âŒ æ£€æŸ¥ ${itemId} çŠ¶æ€å¤±è´¥: ${error.message}`);
          }
        }
      }

      function clearLog() {
        document.getElementById('log').textContent = '';
      }

      function clearStorage() {
        localStorage.removeItem('tag_favorites');
        localStorage.removeItem('tag.currentUserId');
        log('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰å­˜å‚¨æ•°æ®');

        // é‡ç½®æŒ‰é’®çŠ¶æ€
        updateButtonState('collab_test_1', false);
        updateButtonState('collab_test_2', false);
      }

      // åˆå§‹åŒ–
      (async function () {
        // è®¾ç½®æµ‹è¯•ç”¨æˆ·
        localStorage.setItem('tag.currentUserId', 'test_user_123');
        log('ğŸ‘¤ è®¾ç½®æµ‹è¯•ç”¨æˆ·: test_user_123');

        // æ£€æŸ¥åˆå§‹çŠ¶æ€
        await checkAllStatus();
      })();
    </script>
  </body>
</html>
